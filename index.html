<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>居家上班申請系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- 登入畫面 -->
  <div id="loginSection" class="flex min-h-screen items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-bold mb-6 text-center">登入系統</h2>
      <input id="username" class="w-full h-12 rounded-lg border px-4 text-base mb-4" placeholder="請輸入帳號">
      <input id="password" type="password" class="w-full h-12 rounded-lg border px-4 text-base mb-6" placeholder="請輸入密碼">
      <button id="btnLogin" class="w-full h-12 rounded-lg bg-blue-600 text-white">登入</button>
      <p id="loginMsg" class="text-sm mt-3 text-center"></p>
    </div>
  </div>

  <!-- 主畫面 -->
  <div id="appSection" class="hidden p-6">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-xl font-bold">居家上班申請系統</h1>
      <button id="logoutBtn" class="px-3 py-1 text-sm border rounded">登出</button>
    </div>

    <!-- 統計卡 -->
    <div class="grid grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <p class="text-gray-500">本週剩餘天數</p>
        <p id="statWeek" class="text-2xl font-bold">5</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <p class="text-gray-500">雙週剩餘天數</p>
        <p id="statBi" class="text-2xl font-bold">10</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <p class="text-gray-500">本月剩餘天數</p>
        <p id="statMonth" class="text-2xl font-bold">20</p>
      </div>
    </div>

    <!-- 申請表單 -->
    <form id="applyForm" class="bg-white p-6 rounded shadow space-y-4">
      <div>
        <label class="block text-sm text-gray-600 mb-1">申請類型</label>
        <select id="applyType" class="w-full rounded border px-3 py-2">
          <option value="regular">一般</option>
          <option value="urgent">急件</option>
        </select>
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">申請日期（最多5天）</label>
        <input type="date" class="applyDate w-full rounded border px-3 py-2 mb-2">
        <input type="date" class="applyDate w-full rounded border px-3 py-2 mb-2">
        <input type="date" class="applyDate w-full rounded border px-3 py-2 mb-2">
        <input type="date" class="applyDate w-full rounded border px-3 py-2 mb-2">
        <input type="date" class="applyDate w-full rounded border px-3 py-2">
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">原因（急件必填）</label>
        <textarea id="applyReason" class="hidden w-full rounded border px-3 py-2 text-sm"
          placeholder="請填寫急件原因"></textarea>
      </div>

      <p id="applyMsg" class="text-sm"></p>
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">送出申請</button>
    </form>
  </div>

  <script type="module">
    // ===== API Fetch with JWT =====
    async function apiFetch(url, options={}) {
      options.headers = options.headers || {};
      const token = localStorage.getItem('jwt');
      if (token) options.headers['Authorization'] = 'Bearer ' + token;
      if (options.body && typeof options.body === 'object') {
        options.headers['Content-Type'] = 'application/json';
      }
      return fetch(url, options);
    }

    // ===== 日期工具 =====
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate() + n); x.setHours(0,0,0,0); return x; };
    const startOfWeekMon = (d) => { 
      const x = new Date(d); x.setHours(0,0,0,0);
      const dow = x.getDay();
      const offset = (dow === 0 ? -6 : 1 - dow);
      return addDays(x, offset);
    };
    const inRange = (ds, s, e) => { const t = new Date(ds); t.setHours(0,0,0,0); return (t >= s && t <= e); };

    function getWeekRangeForType(type) {
      const today = new Date(); today.setHours(0,0,0,0);
      const thisMon = startOfWeekMon(today);
      const thisSun = addDays(thisMon, 6);

      if (type === 'urgent') {
        const start = today < thisMon ? thisMon : today;
        return { start, end: thisSun };
      } else {
        const nextMon = addDays(thisMon, 7);
        const nextSun = addDays(thisMon, 13);
        return { start: nextMon, end: nextSun };
      }
    }

    function validateDatesByType(type, uniqueDates, reasonText) {
      const range = getWeekRangeForType(type);
      const outOfRange = uniqueDates.some(d => !inRange(d, range.start, range.end));
      if (outOfRange) {
        return { ok: false, msg: (type === 'urgent')
          ? '急件限本週（含今天～週日），不可選過去日期'
          : '一般申請僅能申請下週一至下週日' };
      }
      if (type === 'urgent' && !reasonText.trim()) {
        return { ok: false, msg: '急件申請需填寫原因' };
      }
      return { ok: true, msg: '' };
    }

    function toggleReasonByType(type) {
      const reasonEl = document.getElementById('applyReason');
      if (type === 'urgent') {
        reasonEl.classList.remove('hidden');
        reasonEl.setAttribute('required', 'required');
      } else {
        reasonEl.classList.add('hidden');
        reasonEl.removeAttribute('required');
        reasonEl.value = '';
      }
    }
    document.getElementById('applyType').addEventListener('change', (e) => {
      toggleReasonByType(e.target.value);
    });

    // ===== 登入 =====
    document.getElementById('btnLogin').addEventListener('click', async () => {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      const msg  = document.getElementById('loginMsg');
      msg.textContent = '';

      if (!user || !pass) {
        msg.textContent = '請輸入帳號與密碼';
        msg.className = 'text-sm text-red-600 text-center';
        return;
      }
      try {
        const res = await apiFetch('/api/login', {
          method: 'POST',
          body: JSON.stringify({ username: user, password: pass })
        });
        if (!res.ok) throw new Error('登入失敗');
        const data = await res.json();
        localStorage.setItem('jwt', data.token);
        toApp();
        refreshStats();
      } catch {
        msg.textContent = '登入失敗，請檢查帳號密碼';
        msg.className = 'text-sm text-red-600 text-center';
      }
    });

    // ===== 登出 =====
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('jwt');
      toLogin();
    });

    // ===== 切換畫面 =====
    function toApp() {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('appSection').classList.remove('hidden');
    }
    function toLogin() {
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('appSection').classList.add('hidden');
    }

    // ===== 送申請 =====
    document.getElementById('applyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('applyMsg');
      msg.textContent = '';
      msg.className = 'text-sm';

      const rawDates = [...document.querySelectorAll('input.applyDate')].map(i => i.value.trim()).filter(Boolean);
      if (!rawDates.length) {
        msg.textContent = '請至少選 1 個日期';
        msg.className = 'text-sm text-red-600';
        return;
      }
      const normalized = rawDates.map(d => {
        const t = new Date(d);
        const y = t.getFullYear(), m = String(t.getMonth()+1).padStart(2,'0'), dd = String(t.getDate()).padStart(2,'0');
        return `${y}-${m}-${dd}`;
      });
      const uniqueDates = Array.from(new Set(normalized));
      if (uniqueDates.length !== normalized.length) {
        msg.textContent = '日期不可重複';
        msg.className = 'text-sm text-red-600';
        return;
      }
      if (uniqueDates.length > 5) {
        msg.textContent = '一次最多申請 5 天';
        msg.className = 'text-sm text-red-600';
        return;
      }

      const type = document.getElementById('applyType').value;
      const reason = document.getElementById('applyReason').value;
      const chk = validateDatesByType(type, uniqueDates, reason);
      if (!chk.ok) {
        msg.textContent = chk.msg;
        msg.className = 'text-sm text-red-600';
        return;
      }

      try {
        const res = await apiFetch('/api/applications', {
          method: 'POST',
          body: JSON.stringify({ dates: uniqueDates, type, reason })
        });
        if (!res.ok) throw new Error();
        msg.textContent = '送出成功！';
        msg.className = 'text-sm text-emerald-700';
        document.getElementById('applyForm').reset();
        toggleReasonByType(type);
        refreshStats();
      } catch {
        msg.textContent = '送出失敗，請稍後再試';
        msg.className = 'text-sm text-red-600';
      }
    });

    // ===== 刷新統計卡 =====
    async function refreshStats() {
      try {
        const res = await apiFetch('/api/applications');
        if (!res.ok) return;
        const list = await res.json();

        const today = new Date(); today.setHours(0,0,0,0);
        const thisMon = startOfWeekMon(today);
        const thisSun = addDays(thisMon, 6);
        const prevMon = addDays(thisMon, -7);
        const biStart = prevMon, biEnd = thisSun;
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1); monthStart.setHours(0,0,0,0);
        const monthEnd = new Date(today.getFullYear(), today.getMonth()+1, 0); monthEnd.setHours(0,0,0,0);

        let usedWeek=0, usedBi=0, usedMonth=0;

        for (const row of list || []) {
          if (row.status === 'rejected') continue;
          let dates = [];
          try { dates = JSON.parse(row.datesJson) || []; } catch {}
          for (const ds of dates) {
            const d = new Date(ds); d.setHours(0,0,0,0);
            if (d >= thisMon && d <= thisSun) usedWeek++;
            if (d >= biStart && d <= biEnd) usedBi++;
            if (d >= monthStart && d <= monthEnd) usedMonth++;
          }
        }
        document.getElementById('statWeek').textContent = Math.max(0, 5 - usedWeek);
        document.getElementById('statBi').textContent = Math.max(0, 10 - usedBi);
        document.getElementById('statMonth').textContent = Math.max(0, 20 - usedMonth);
      } catch {}
    }

    // ===== 初始化 =====
    if (localStorage.getItem('jwt')) {
      toApp();
      refreshStats();
    }
    toggleReasonByType(document.getElementById('applyType').value);
  </script>

</body>
</html>
