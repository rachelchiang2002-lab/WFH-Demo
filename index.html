<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>居家上班登記系統</title>
  <!-- Tailwind（示範用 CDN；正式可改為本地/打包） -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-4 md:p-6">
    <!-- 頁首 -->
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-xl md:text-2xl font-semibold">居家上班登記系統</h1>
      <div class="flex items-center gap-3">
        <span id="whoami" class="text-sm text-slate-600"></span>
        <button id="logoutBtn" class="hidden text-sm px-3 py-1.5 rounded-md bg-slate-200 hover:bg-slate-300">登出</button>
      </div>
    </header>

    <!-- 登入區塊 -->
    <section id="loginSection" class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl shadow p-6 md:p-8">
        <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-full bg-blue-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M12 11c1.657 0 3-1.567 3-3.5S13.657 4 12 4 9 5.567 9 7.5 10.343 11 12 11zm0 2c-3.866 0-7 2.239-7 5v1h14v-1c0-2.761-3.134-5-7-5z"/>
          </svg>
        </div>
        <h2 class="text-center text-lg font-semibold mb-6">請使用帳號密碼登入</h2>

        <form id="loginForm" class="grid gap-4">
          <label class="text-sm">
            帳號
            <input id="username" class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"
                   placeholder="請輸入帳號" autocomplete="username" />
          </label>
          <label class="text-sm">
            密碼
            <input id="password" type="password" class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500"
                   placeholder="請輸入密碼" autocomplete="current-password" />
          </label>

          <button type="submit" class="mt-2 w-full rounded-lg bg-blue-600 text-white py-2.5 font-medium hover:bg-blue-700">
            登入系統
          </button>
          <p id="loginError" class="h-5 text-center text-sm text-red-600"></p>
        </form>
      </div>
    </section>

    <!-- 主功能區（登入後顯示） -->
    <section id="appSection" class="hidden">
      <!-- 假導覽 -->
      <nav class="mb-4">
        <ul class="flex items-center gap-3 text-sm">
          <li class="px-3 py-1.5 rounded-md bg-white shadow font-medium">申請居家上班</li>
          <li class="px-3 py-1.5 rounded-md text-slate-500">待核准申請</li>
          <li class="px-3 py-1.5 rounded-md text-slate-500">申請記錄</li>
          <li class="px-3 py-1.5 rounded-md text-slate-500">月報統計</li>
        </ul>
      </nav>

      <div class="bg-white rounded-2xl shadow p-5 md:p-7">
        <!-- 三張統計卡（下一步再串真數字） -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
          <div class="rounded-xl border border-slate-200 p-4">
            <div class="text-3xl font-bold text-purple-600 text-center">5</div>
            <div class="text-center text-sm mt-1">本周剩餘天數<br><span class="text-xs text-slate-500">（單周最多 5 天）</span></div>
          </div>
          <div class="rounded-xl border border-slate-200 p-4">
            <div class="text-3xl font-bold text-blue-600 text-center">10</div>
            <div class="text-center text-sm mt-1">雙周剩餘天數<br><span class="text-xs text-slate-500">（兩週合計最多 10 天）</span></div>
          </div>
          <div class="rounded-xl border border-slate-200 p-4">
            <div class="text-3xl font-bold text-green-600 text-center">20</div>
            <div class="text-center text-sm mt-1">本月剩餘天數<br><span class="text-xs text-slate-500">（每月最多 20 天）</span></div>
          </div>
        </div>

        <!-- 申請表單 -->
        <form id="applyForm" class="grid gap-4">
          <div>
            <label class="text-sm">申請類型</label>
            <select id="applyType" class="mt-1 w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500">
              <option value="regular" selected>一般（regular）</option>
              <option value="urgent">急件（urgent）</option>
            </select>
          </div>

          <div>
            <label class="text-sm">申請日期（最多可選 5 天）</label>
            <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3">
              <input type="date" class="applyDate rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500" />
              <input type="date" class="applyDate rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500" />
              <input type="date" class="applyDate rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500" />
              <input type="date" class="applyDate rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500" />
              <input type="date" class="applyDate rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500" />
            </div>
          </div>

          <div class="flex items-center gap-3">
            <button type="submit" class="rounded-lg bg-blue-600 text-white px-4 py-2.5 font-medium hover:bg-blue-700">
              提交申請
            </button>
            <span id="applyMsg" class="text-sm text-emerald-700"></span>
          </div>
        </form>
      </div>

      <!-- 下方輸出（方便測試觀察） -->
      <pre id="out" class="mt-6 whitespace-pre-wrap bg-slate-100 rounded-xl p-4 border border-slate-200 text-sm"></pre>
    </section>
  </div>

  <script type="module">
    // === API base ===
    const API_BASE = "https://wfh-demo.onrender.com";

    // === 小工具 ===
    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    const show = (obj) => {
      const el = $("#out");
      if (!el) return;
      el.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    };

    // === Token 存取 ===
    function saveToken(t){ localStorage.setItem("jwt", t); }
    function getToken(){  return localStorage.getItem("jwt"); }
    function clearToken(){ localStorage.removeItem("jwt"); }

    // === 帶 Authorization 的 fetch ===
    async function apiFetch(path, options = {}) {
      const token = getToken();
      const headers = Object.assign(
        { "Content-Type": "application/json" },
        options.headers || {}
      );
      if (token) headers["Authorization"] = `Bearer ${token}`;
      return fetch(`${API_BASE}${path}`, { ...options, headers });
    }

    // === 顯示/隱藏區塊 ===
    const loginSection = $("#loginSection");
    const appSection   = $("#appSection");
    function toApp(){
      loginSection?.classList.add("hidden");
      appSection?.classList.remove("hidden");
    }
    function toLogin(){
      appSection?.classList.add("hidden");
      loginSection?.classList.remove("hidden");
    }

    // === 登入 ===
    const loginForm  = $("#loginForm");
    const userInput  = $("#username");
    const passInput  = $("#password");
    const loginError = $("#loginError");
    const whoamiEl   = $("#whoami");
    const logoutBtn  = $("#logoutBtn");

    loginForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.textContent = "";

      const username = (userInput?.value || "").trim();
      const password = (passInput?.value || "").trim();
      if (!username || !password) {
        loginError.textContent = "請輸入帳號與密碼";
        return;
      }

      try {
        // 可選：喚醒後端（避免冷啟動）
        await fetch(`${API_BASE}/api/health`).catch(()=>{});

        const res = await fetch(`${API_BASE}/api/login`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) {
          loginError.textContent = res.status === 401 ? "帳號或密碼錯誤" : `登入失敗（${res.status}）`;
          return;
        }

        const data = await res.json(); // { token, name, role }
        if (!data?.token) { loginError.textContent = "登入回應不完整"; return; }

        saveToken(data.token);
        if (whoamiEl) whoamiEl.textContent = `${data.name}（${data.role}）`;
        toApp();
      } catch (err) {
        console.error(err);
        loginError.textContent = "登入失敗，請稍後再試";
      }
    });

    // === 登出 ===
    logoutBtn?.addEventListener("click", () => {
      clearToken();
      if (whoamiEl) whoamiEl.textContent = "";
      toLogin();
      show("");
    });

    // === 送申請（只有 /api/applications，沒有 /api/apply） ===
    const applyForm  = $("#applyForm");
    const applyType  = $("#applyType");
    const applyMsg   = $("#applyMsg");
    const dateInputs = [...$$("input.applyDate")];

    // 防重複綁定
    if (applyForm && !applyForm.dataset.bound) {
      applyForm.dataset.bound = "1";
      applyForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        applyMsg.textContent = "";
        show("");

        // 蒐集日期
        const dates = dateInputs
          .map(i => (i.value || "").trim())
          .filter(Boolean)
          .map(d => {
            const dt = new Date(d);
            if (Number.isNaN(dt.getTime())) return null;
            const y = dt.getFullYear();
            const m = String(dt.getMonth()+1).padStart(2,"0");
            const dd= String(dt.getDate()).padStart(2,"0");
            return `${y}-${m}-${dd}`;
          })
          .filter(Boolean);

        if (!applyType?.value) {
          applyMsg.textContent = "請先選擇「申請類型」。";
          applyMsg.className = "text-sm text-red-600";
          return;
        }
        if (dates.length === 0) {
          applyMsg.textContent = "請至少選 1 個日期。";
          applyMsg.className = "text-sm text-red-600";
          return;
        }
        if (dates.length > 5) {
          applyMsg.textContent = "一次最多只能選 5 天。";
          applyMsg.className = "text-sm text-red-600";
          return;
        }

        try {
          const res = await apiFetch("/api/applications", {
            method: "POST",
            body: JSON.stringify({
              dates,
              type: applyType.value,
              reason: "前端送件（Canva 內頁）"
            })
          });

          if (!res.ok) {
            applyMsg.textContent = `送出失敗（${res.status}）`;
            applyMsg.className = "text-sm text-red-600";
            const t = await res.text().catch(()=> "");
            if (t) show(t);
            return;
          }

          const data = await res.json(); // { appId: n }
          applyMsg.textContent = "送出成功！";
          applyMsg.className = "text-sm text-emerald-700";
          show({ api: "/api/applications", payload: { dates, type: applyType.value }, result: data });

          // 清空日期欄（保留類型）
          dateInputs.forEach(i => i.value = "");
        } catch (err) {
          console.error(err);
          applyMsg.textContent = "送出失敗，請稍後再試";
          applyMsg.className = "text-sm text-red-600";
        }
      });
    }

    // === 首次載入：若已有 token，直接進主畫面 ===
    (async () => {
      const token = getToken();
      if (!token) return;
      try {
        // 簡單驗證/喚醒
        const r = await apiFetch("/api/health");
        if (r.ok) {
          // 不知道使用者姓名時，先顯示「已登入」
          if (whoamiEl && !whoamiEl.textContent) whoamiEl.textContent = "已登入";
          toApp();
        }
      } catch {}
    })();
  </script>
</body>
</html>
