<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>居家上班登記系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Tailwind CDN（會有黃色提醒，可忽略） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.hidden{display:none}</style>
</head>
<body class="bg-slate-100 min-h-screen flex items-start md:items-center justify-center">
  <main class="w-full max-w-5xl mx-auto p-4 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-8">

    <!-- 登入卡片：外層一定要有這個 id -->
    <section id="loginSection" class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-md mx-auto">
      <div class="flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-blue-600 mx-auto mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-9 h-9" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2a5 5 0 00-5 5v2H6a2 2 0 00-2 2v8a3 3 0 003 3h10a3 3 0 003-3v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm-3 7V7a3 3 0 116 0v2H9z"/>
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-center mb-2">居家上班登記系統</h1>
      <p class="text-center text-slate-500 mb-6">請使用您的帳號密碼登入</p>

      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm text-slate-600 mb-1">帳號</label>
          <input id="username" class="w-full border rounded-lg p-3 outline-none focus:ring focus:ring-blue-200" placeholder="請輸入帳號" autocomplete="username">
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">密碼</label>
          <input id="password" type="password" class="w-full border rounded-lg p-3 outline-none focus:ring focus:ring-blue-200" placeholder="請輸入密碼" autocomplete="current-password">
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg py-3 font-medium">登入系統</button>
        <div id="loginError" class="text-red-600 text-sm mt-2"></div>
      </form>
    </section>

    <!-- 主畫面：登入成功才顯示 -->
    <section id="appSection" class="hidden bg-white rounded-2xl shadow-lg p-6 md:p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h2 class="text-xl font-bold">申請作業</h2>
          <p class="text-slate-500" id="whoami">已登入</p>
        </div>
        <button id="logoutBtn" class="px-4 py-2 rounded-lg border text-slate-700 hover:bg-slate-50">登出</button>
      </div>

      <div class="grid gap-4 sm:grid-cols-2">
        <div class="border rounded-xl p-4">
          <h3 class="font-semibold mb-2">送出申請（範例）</h3>
          <p class="text-sm text-slate-500 mb-3">會送兩天 regular 申請，純測試。</p>
          <button id="btnDemoCreate" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">送出測試申請</button>
        </div>
        <div class="border rounded-xl p-4">
          <h3 class="font-semibold mb-2">查看清單</h3>
          <p class="text-sm text-slate-500 mb-3">列出最近的申請資料。</p>
          <button id="btnList" class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">讀取清單</button>
        </div>
      </div>

      <pre id="out" class="mt-6 p-3 bg-slate-50 rounded-lg text-sm overflow-auto max-h-80"></pre>
    </section>
  </main>

  <!-- 內嵌 JS：不再依賴 main.js 檔，避免 404 -->
  <script type="module">
    // === 設定：你的雲端 API ===
    const API_BASE = "https://wfh-demo.onrender.com";

    // === 工具 ===
    const $  = (s)=>document.querySelector(s);
    const show = (x)=>{ const el=$("#out"); if(el) el.textContent = typeof x==="string"?x:JSON.stringify(x,null,2); };

    // === Token ===
    const saveToken = t=>localStorage.setItem("jwt",t);
    const getToken  = ()=>localStorage.getItem("jwt");
    const clearToken= ()=>localStorage.removeItem("jwt");

    // === 自動帶 Authorization 的 fetch ===
    async function apiFetch(path, options={}){
      const token = getToken();
      const headers = Object.assign({"Content-Type":"application/json"}, options.headers||{});
      if(token) headers["Authorization"] = `Bearer ${token}`;
      return fetch(`${API_BASE}${path}`, { ...options, headers });
    }

    // === 抓元素 ===
    const loginSection = $("#loginSection");
    const loginForm = $("#loginForm");
    const userInput = $("#username");
    const passInput = $("#password");
    const loginError = $("#loginError");
    const appSection = $("#appSection");
    const whoami = $("#whoami");
    const logoutBtn = $("#logoutBtn");
    const btnDemoCreate = $("#btnDemoCreate");
    const btnList = $("#btnList");

    // === 畫面切換 ===
    function toApp(me){
      loginSection?.classList.add("hidden");
      appSection?.classList.remove("hidden");
      if(whoami && me) whoami.textContent = `${me.name || me.username}（${me.role || ""}）`;
    }
    function toLogin(){
      appSection?.classList.add("hidden");
      loginSection?.classList.remove("hidden");
      if(loginError) loginError.textContent = "";
    }

    // 如果本地已有 token，就先讓使用者進主畫面（避免空白）
    if(getToken()){ toApp(); }

    // === 登入 ===
    loginForm?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      loginError.textContent = "";

      try{
        // 先喚醒後端（免費方案冷啟動）
        fetch(`${API_BASE}/api/health`).catch(()=>{});
        const res = await fetch(`${API_BASE}/api/login`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            username: (userInput?.value||"").trim(),
            password: (passInput?.value||"")
          })
        });
        if(!res.ok){
          loginError.textContent = res.status===401 ? "帳號或密碼錯誤" : `登入失敗（${res.status}）`;
          return;
        }
        const data = await res.json(); // { token, name, role }
        saveToken(data.token);
        toApp(data);
        alert(`登入成功：${data.name||""}（${data.role||""}）`);
      }catch(err){
        loginError.textContent = "登入失敗，請稍後再試";
        console.error(err);
      }
    });

    // === 登出 ===
    logoutBtn?.addEventListener("click", ()=>{
      clearToken();
      toLogin();
    });

    // === 範例：送出申請 ===
    btnDemoCreate?.addEventListener("click", async ()=>{
      try{
        const res = await apiFetch("/api/applications", {
          method:"POST",
          body: JSON.stringify({
            dates:["2025-08-20","2025-08-21"],
            type:"regular",
            reason:"前端測試送件（雲端）"
          })
        });
        show(await res.json());
      }catch(e){ show("送件失敗"); }
    });

    // === 範例：讀取清單 ===
    btnList?.addEventListener("click", async ()=>{
      try{
        const res = await apiFetch("/api/applications");
        show(await res.json());
      }catch(e){ show("讀取失敗"); }
    });
  </script>
</body>
</html>
