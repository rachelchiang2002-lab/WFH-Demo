<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>居家上班登記系統</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Tailwind CDN（會有黃色提醒，可忽略） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.hidden{display:none}</style>
</head>
<body class="bg-slate-100 min-h-screen flex items-start md:items-center justify-center">
  <main class="w-full max-w-5xl mx-auto p-4 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-8">

    <!-- 登入卡片：外層一定要有這個 id -->
    <section id="loginSection" class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-md mx-auto">
      <div class="flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-blue-600 mx-auto mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-9 h-9" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2a5 5 0 00-5 5v2H6a2 2 0 00-2 2v8a3 3 0 003 3h10a3 3 0 003-3v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm-3 7V7a3 3 0 116 0v2H9z"/>
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-center mb-2">居家上班登記系統</h1>
      <p class="text-center text-slate-500 mb-6">請使用您的帳號密碼登入</p>

      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm text-slate-600 mb-1">帳號</label>
          <input id="username" class="w-full border rounded-lg p-3 outline-none focus:ring focus:ring-blue-200" placeholder="請輸入帳號" autocomplete="username">
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">密碼</label>
          <input id="password" type="password" class="w-full border rounded-lg p-3 outline-none focus:ring focus:ring-blue-200" placeholder="請輸入密碼" autocomplete="current-password">
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg py-3 font-medium">登入系統</button>
        <div id="loginError" class="text-red-600 text-sm mt-2"></div>
      </form>
    </section>

    <!-- 主畫面：登入成功才顯示 -->
    <section id="appSection" class="bg-white rounded-2xl shadow-lg p-0 overflow-hidden w-full">
  <!-- 頂端導覽列 -->
  <header class="flex items-center justify-between bg-slate-50 px-6 py-4 border-b">
    <nav class="flex gap-6 text-sm">
      <a class="text-blue-600 font-medium border-b-2 border-blue-600 pb-1" href="javascript:void(0)">申請居家上班</a>
      <a class="text-slate-500 hover:text-slate-700" href="javascript:void(0)">待核准申請</a>
      <a class="text-slate-500 hover:text-slate-700" href="javascript:void(0)">申請記錄</a>
      <a class="text-slate-500 hover:text-slate-700" href="javascript:void(0)">月報統計</a>
    </nav>
    <div class="flex items-center gap-3 text-sm">
      <span id="whoami" class="text-slate-600">Rachel（L1）</span>
      <button id="logoutBtn" class="px-3 py-1.5 rounded-lg border text-slate-700 hover:bg-slate-100">登出</button>
    </div>
  </header>

  <!-- 內容區 -->
  <div class="p-6 md:p-8">
    <h2 class="text-lg font-semibold mb-4">申請居家上班</h2>

    <!-- 三個統計卡片 -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="rounded-xl border bg-indigo-50/40 p-4">
        <p class="text-violet-700 text-3xl font-extrabold text-center" id="cntWeek">5</p>
        <p class="text-center text-slate-500 text-sm">本周剩餘天數<br><span class="text-xs">(單周最多 5 天)</span></p>
      </div>
      <div class="rounded-xl border bg-blue-50/40 p-4">
        <p class="text-blue-700 text-3xl font-extrabold text-center" id="cntBiWeek">10</p>
        <p class="text-center text-slate-500 text-sm">雙周剩餘天數<br><span class="text-xs">(兩週合計最多 10 天)</span></p>
      </div>
      <div class="rounded-xl border bg-emerald-50/40 p-4">
        <p class="text-emerald-700 text-3xl font-extrabold text-center" id="cntMonth">20</p>
        <p class="text-center text-slate-500 text-sm">本月剩餘天數<br><span class="text-xs">(每月最多 20 天)</span></p>
      </div>
    </div>

    <!-- 申請表單 -->
    <form id="applyForm" class="space-y-4 max-w-3xl">
      <!-- 申請類型 -->
      <div>
        <label class="block text-sm text-slate-600 mb-1">申請類型</label>
        <select id="applyType" class="w-full border rounded-lg px-3 py-2 outline-none focus:ring focus:ring-blue-200">
          <option value="" selected>請選擇</option>
          <option value="regular">一般（regular）</option>
          <option value="urgent">急件（urgent）</option>
        </select>
      </div>

      <!-- 日期（最多五天） -->
      <div>
        <label class="block text-sm text-slate-600 mb-1">申請日期（最多可選 5 天）</label>
        <div class="space-y-3">
          <input type="date" class="applyDate w-full border rounded-lg px-3 py-2">
          <input type="date" class="applyDate w-full border rounded-lg px-3 py-2">
          <input type="date" class="applyDate w-full border rounded-lg px-3 py-2">
          <input type="date" class="applyDate w-full border rounded-lg px-3 py-2">
          <input type="date" class="applyDate w-full border rounded-lg px-3 py-2">
        </div>
      </div>

      <!-- 送出 -->
      <div class="pt-2">
        <button id="btnSubmit" type="submit"
                class="px-5 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white">
          提交申請
        </button>
        <span id="applyMsg" class="ml-3 text-sm text-slate-600"></span>
      </div>
    </form>

    <!-- 結果輸出區（保留） -->
    <pre id="out" class="mt-6 p-3 bg-slate-50 rounded-lg text-sm overflow-auto max-h-80"></pre>
  </div>
</section>
  </main>

  <!-- 內嵌 JS：不再依賴 main.js 檔，避免 404 -->
  <script type="module">
    // === 設定：你的雲端 API ===
    const API_BASE = "https://wfh-demo.onrender.com";

    // === 工具 ===
    const $  = (s)=>document.querySelector(s);
    const show = (x)=>{ const el=$("#out"); if(el) el.textContent = typeof x==="string"?x:JSON.stringify(x,null,2); };

    // === Token ===
    const saveToken = t=>localStorage.setItem("jwt",t);
    const getToken  = ()=>localStorage.getItem("jwt");
    const clearToken= ()=>localStorage.removeItem("jwt");

    // === 自動帶 Authorization 的 fetch ===
    async function apiFetch(path, options={}){
      const token = getToken();
      const headers = Object.assign({"Content-Type":"application/json"}, options.headers||{});
      if(token) headers["Authorization"] = `Bearer ${token}`;
      return fetch(`${API_BASE}${path}`, { ...options, headers });
    }

    // === 抓元素 ===
    const loginSection = $("#loginSection");
    const loginForm = $("#loginForm");
    const userInput = $("#username");
    const passInput = $("#password");
    const loginError = $("#loginError");
    const appSection = $("#appSection");
    const whoami = $("#whoami");
    const logoutBtn = $("#logoutBtn");
    const btnDemoCreate = $("#btnDemoCreate");
    const btnList = $("#btnList");

    // === 畫面切換 ===
    function toApp(me){
      loginSection?.classList.add("hidden");
      appSection?.classList.remove("hidden");
      if(whoami && me) whoami.textContent = `${me.name || me.username}（${me.role || ""}）`;
    }
    function toLogin(){
      appSection?.classList.add("hidden");
      loginSection?.classList.remove("hidden");
      if(loginError) loginError.textContent = "";
    }

    // 如果本地已有 token，就先讓使用者進主畫面（避免空白）
    if(getToken()){ toApp(); }

    // === 登入 ===
    loginForm?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      loginError.textContent = "";

      try{
        // 先喚醒後端（免費方案冷啟動）
        fetch(`${API_BASE}/api/health`).catch(()=>{});
        const res = await fetch(`${API_BASE}/api/login`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            username: (userInput?.value||"").trim(),
            password: (passInput?.value||"")
          })
        });
        if(!res.ok){
          loginError.textContent = res.status===401 ? "帳號或密碼錯誤" : `登入失敗（${res.status}）`;
          return;
        }
        const data = await res.json(); // { token, name, role }
        saveToken(data.token);
        toApp(data);
        alert(`登入成功：${data.name||""}（${data.role||""}）`);
      }catch(err){
        loginError.textContent = "登入失敗，請稍後再試";
        console.error(err);
      }
    });

    // === 登出 ===
    logoutBtn?.addEventListener("click", ()=>{
      clearToken();
      toLogin();
    });

    // === 範例：送出申請 ===
    btnDemoCreate?.addEventListener("click", async ()=>{
      try{
        const res = await apiFetch("/api/applications", {
          method:"POST",
          body: JSON.stringify({
            dates:["2025-08-20","2025-08-21"],
            type:"regular",
            reason:"前端測試送件（雲端）"
          })
        });
        show(await res.json());
      }catch(e){ show("送件失敗"); }
    });

    // === 範例：讀取清單 ===
    btnList?.addEventListener("click", async ()=>{
      try{
        const res = await apiFetch("/api/applications");
        show(await res.json());
      }catch(e){ show("讀取失敗"); }
    });
  // ====== 第 2 小步：提交申請（只串 API；統計下步做） ======

// 取得表單元素
const applyForm  = document.querySelector('#applyForm');
const applyType  = document.querySelector('#applyType');
const applyMsg   = document.querySelector('#applyMsg');
const dateInputs = Array.from(document.querySelectorAll('input.applyDate'));

// 小工具：轉 YYYY-MM-DD
function toYMD(d) {
  if (!d) return null;
  const dt = new Date(d);
  if (isNaN(dt.getTime())) return null;
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const dd= String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}

applyForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  applyMsg.textContent = '';
  show(''); // 清空下方輸出

  // 蒐集日期
  const dates = dateInputs
    .map(i => i.value.trim())
    .filter(Boolean)
    .map(toYMD)
    .filter(Boolean);

  // 基本檢查
  if (!applyType?.value) {
    applyMsg.textContent = '請先選擇「申請類型」。';
    applyMsg.className = 'ml-3 text-sm text-red-600';
    return;
  }
  if (dates.length === 0) {
    applyMsg.textContent = '請至少選擇 1 個日期。';
    applyMsg.className = 'ml-3 text-sm text-red-600';
    return;
  }
  if (dates.length > 5) {
    applyMsg.textContent = '一次最多只能選 5 天。';
    applyMsg.className = 'ml-3 text-sm text-red-600';
    return;
  }

  try {
    // 送到後端
    const res = await apiFetch('/api/applications', {
      method: 'POST',
      body: JSON.stringify({
        dates,                 // 例如 ["2025-08-20","2025-08-21"]
        type: applyType.value, // "regular" 或 "urgent"
        reason: '前端送件（Canva 內頁）'
      })
    });

    if (!res.ok) {
      applyMsg.textContent = `送出失敗（${res.status}）`;
      applyMsg.className = 'ml-3 text-sm text-red-600';
      const t = await res.text().catch(()=> '');
      if (t) show(t);
      return;
    }

    const data = await res.json();
    applyMsg.textContent = '送出成功！';
    applyMsg.className = 'ml-3 text-sm text-emerald-700';

    // 把回應顯示在下方
    show({ api: '/api/applications', payload: { dates, type: applyType.value }, result: data });

    // 成功後清空表單（日期欄位）但保留類型
    dateInputs.forEach(i => i.value = '');

    // 統計卡片我們在下一步更新（先不動）
  } catch (err) {
    console.error(err);
    applyMsg.textContent = '送出失敗，請稍後再試';
    applyMsg.className = 'ml-3 text-sm text-red-600';
  }
});

</script>
</body>
</html>
